import { LMSDataPoint } from './types';

// WHO Child Growth Standards (0-24 months)
// Source: WHO Length/Weight standards
// Format: [Month, L, M, S]

const WHO_WEIGHT_BOYS = [
  [0, 0.13, 3.3, 0.13], [1, 0.13, 4.5, 0.13], [2, 0.13, 5.6, 0.12], [3, 0.13, 6.4, 0.12],
  [4, 0.13, 7.0, 0.12], [5, 0.13, 7.5, 0.12], [6, 0.13, 7.9, 0.11], [9, 0.13, 8.9, 0.11],
  [12, 0.13, 9.6, 0.11], [15, 0.13, 10.3, 0.11], [18, 0.13, 10.9, 0.11], [21, 0.13, 11.5, 0.11], [24, 0.13, 12.2, 0.11]
];

const WHO_WEIGHT_GIRLS = [
  [0, 0.15, 3.2, 0.14], [1, 0.15, 4.2, 0.14], [2, 0.15, 5.1, 0.13], [3, 0.15, 5.8, 0.13],
  [4, 0.15, 6.4, 0.13], [5, 0.15, 6.9, 0.13], [6, 0.15, 7.3, 0.12], [9, 0.15, 8.2, 0.12],
  [12, 0.15, 8.9, 0.12], [15, 0.15, 9.6, 0.12], [18, 0.15, 10.2, 0.12], [21, 0.15, 10.9, 0.12], [24, 0.15, 11.5, 0.12]
];

const WHO_LENGTH_BOYS = [
  [0, 1, 49.9, 0.04], [1, 1, 54.7, 0.04], [2, 1, 58.4, 0.04], [3, 1, 61.4, 0.04],
  [6, 1, 67.6, 0.04], [9, 1, 72.0, 0.04], [12, 1, 75.7, 0.04], [18, 1, 82.3, 0.04], [24, 1, 87.8, 0.04]
];

const WHO_LENGTH_GIRLS = [
  [0, 1, 49.1, 0.04], [1, 1, 53.7, 0.04], [2, 1, 57.1, 0.04], [3, 1, 59.8, 0.04],
  [6, 1, 65.7, 0.04], [9, 1, 70.1, 0.04], [12, 1, 74.0, 0.04], [18, 1, 80.7, 0.04], [24, 1, 86.4, 0.04]
];

const WHO_BMI_BOYS = [
  [0, -0.21, 13.4, 0.10], [1, -0.21, 14.9, 0.10], [6, -0.21, 17.3, 0.10], [12, -0.21, 16.9, 0.09], [24, -0.21, 16.0, 0.09]
];

const WHO_BMI_GIRLS = [
  [0, -0.06, 13.3, 0.09], [1, -0.06, 14.6, 0.09], [6, -0.06, 16.9, 0.09], [12, -0.06, 16.6, 0.09], [24, -0.06, 15.7, 0.09]
];

// CDC Growth Charts (2-20 years)
// Source: CDC 2000 Growth Charts
// Format: [Month, L, M, S]

const CDC_WEIGHT_BOYS = [
  [24, -0.13, 12.7, 0.12], [36, -0.13, 14.3, 0.12], [48, -0.13, 16.3, 0.12],
  [60, -0.13, 18.3, 0.12], [72, -0.13, 20.5, 0.12], [84, -0.13, 22.9, 0.12],
  [96, -0.13, 25.4, 0.13], [108, -0.13, 28.1, 0.13], [120, -0.13, 31.2, 0.13],
  [132, -0.13, 34.2, 0.13], [144, -0.13, 37.8, 0.13], [156, -0.13, 41.7, 0.13],
  [168, -0.13, 45.8, 0.14], [180, -0.13, 50.8, 0.14], [192, -0.13, 56.0, 0.14],
  [204, -0.13, 60.8, 0.14], [216, -0.13, 65.3, 0.15], [228, -0.13, 68.9, 0.15], [240, -0.13, 70.3, 0.15]
];

const CDC_WEIGHT_GIRLS = [
  [24, -0.36, 12.1, 0.12], [36, -0.36, 13.9, 0.13], [48, -0.36, 15.8, 0.13],
  [60, -0.36, 17.7, 0.13], [72, -0.36, 20.2, 0.14], [84, -0.36, 22.8, 0.14],
  [96, -0.36, 25.6, 0.15], [108, -0.36, 29.0, 0.16], [120, -0.36, 32.9, 0.16],
  [132, -0.36, 37.0, 0.17], [144, -0.36, 41.5, 0.17], [156, -0.36, 45.4, 0.17],
  [168, -0.36, 48.8, 0.17], [180, -0.36, 51.4, 0.17], [192, -0.36, 53.0, 0.17],
  [204, -0.36, 54.4, 0.17], [216, -0.36, 55.6, 0.17], [228, -0.36, 56.3, 0.17], [240, -0.36, 56.8, 0.17]
];

const CDC_HEIGHT_BOYS = [
  [24, 1, 86.8, 0.04], [36, 1, 95.6, 0.04], [48, 1, 102.9, 0.04],
  [60, 1, 109.1, 0.04], [72, 1, 115.3, 0.04], [84, 1, 121.7, 0.04],
  [96, 1, 128.0, 0.04], [108, 1, 133.5, 0.04], [120, 1, 138.6, 0.04],
  [132, 1, 143.7, 0.04], [144, 1, 149.1, 0.04], [156, 1, 155.2, 0.04],
  [168, 1, 161.9, 0.04], [180, 1, 169.0, 0.04], [192, 1, 173.5, 0.04],
  [204, 1, 175.7, 0.04], [216, 1, 176.5, 0.04], [228, 1, 176.9, 0.04], [240, 1, 177.0, 0.04]
];

const CDC_HEIGHT_GIRLS = [
  [24, 1, 86.4, 0.04], [36, 1, 94.9, 0.04], [48, 1, 102.1, 0.04],
  [60, 1, 108.4, 0.04], [72, 1, 114.6, 0.04], [84, 1, 120.6, 0.04],
  [96, 1, 126.5, 0.04], [108, 1, 132.2, 0.04], [120, 1, 138.3, 0.04],
  [132, 1, 144.8, 0.04], [144, 1, 151.2, 0.04], [156, 1, 156.4, 0.04],
  [168, 1, 160.4, 0.04], [180, 1, 162.2, 0.04], [192, 1, 162.8, 0.04],
  [204, 1, 163.1, 0.04], [216, 1, 163.4, 0.04], [228, 1, 163.5, 0.04], [240, 1, 163.6, 0.04]
];

const CDC_BMI_BOYS = [
  [24, -2.1, 16.4, 0.08], [36, -1.9, 15.9, 0.08], [48, -1.6, 15.5, 0.08],
  [60, -1.4, 15.3, 0.09], [72, -1.2, 15.4, 0.10], [84, -1.1, 15.6, 0.10],
  [96, -1.1, 16.0, 0.11], [108, -1.1, 16.5, 0.12], [120, -1.2, 17.0, 0.12],
  [132, -1.3, 17.6, 0.13], [144, -1.5, 18.3, 0.13], [156, -1.6, 19.1, 0.14],
  [168, -1.8, 20.2, 0.14], [180, -2.0, 21.4, 0.14], [192, -2.1, 22.7, 0.15],
  [204, -2.1, 23.9, 0.15], [216, -2.2, 24.8, 0.15], [228, -2.1, 25.3, 0.15], [240, -1.9, 25.5, 0.15]
];

const CDC_BMI_GIRLS = [
  [24, -1.9, 16.0, 0.08], [36, -1.7, 15.6, 0.08], [48, -1.5, 15.3, 0.08],
  [60, -1.2, 15.2, 0.09], [72, -1.0, 15.3, 0.10], [84, -0.8, 15.7, 0.10],
  [96, -0.6, 16.3, 0.11], [108, -0.5, 17.0, 0.11], [120, -0.4, 17.8, 0.12],
  [132, -0.3, 18.6, 0.13], [144, -0.2, 19.4, 0.13], [156, -0.1, 20.1, 0.13],
  [168, 0.0, 20.8, 0.14], [180, 0.2, 21.4, 0.14], [192, 0.4, 22.2, 0.15],
  [204, 0.5, 23.0, 0.15], [216, 0.6, 23.6, 0.16], [228, 0.6, 23.9, 0.16], [240, 0.6, 24.0, 0.16]
];

// Linear interpolation helper
// Finds the two closest data points and interpolates L, M, S
const interpolateLMS = (age: number, dataset: number[][]): LMSDataPoint => {
  if (age <= dataset[0][0]) {
    const [m, l, mean, s] = dataset[0];
    return { month: age, L: l, M: mean, S: s };
  }
  if (age >= dataset[dataset.length - 1][0]) {
    const [m, l, mean, s] = dataset[dataset.length - 1];
    return { month: age, L: l, M: mean, S: s };
  }

  // Find the interval
  let i = 0;
  while (i < dataset.length - 1 && dataset[i + 1][0] < age) {
    i++;
  }

  const p1 = dataset[i];
  const p2 = dataset[i + 1];

  const t = (age - p1[0]) / (p2[0] - p1[0]);

  // Linear interpolation
  const L = p1[1] + (p2[1] - p1[1]) * t;
  const M = p1[2] + (p2[2] - p1[2]) * t;
  const S = p1[3] + (p2[3] - p1[3]) * t;

  return { month: age, L, M, S };
};

export const getLMSForAge = (sex: 'male' | 'female', type: 'weight' | 'height' | 'bmi', month: number): LMSDataPoint => {
    // 0-24 Months -> WHO Standards
    if (month < 24) {
      if (type === 'weight') {
        return interpolateLMS(month, sex === 'male' ? WHO_WEIGHT_BOYS : WHO_WEIGHT_GIRLS);
      } else if (type === 'height') { // Length for < 24m
        return interpolateLMS(month, sex === 'male' ? WHO_LENGTH_BOYS : WHO_LENGTH_GIRLS);
      } else if (type === 'bmi') {
         return interpolateLMS(month, sex === 'male' ? WHO_BMI_BOYS : WHO_BMI_GIRLS);
      }
    }
    
    // 24+ Months -> CDC Standards
    // Note: For CDC, data starts at 24 months.
    if (type === 'weight') {
      return interpolateLMS(month, sex === 'male' ? CDC_WEIGHT_BOYS : CDC_WEIGHT_GIRLS);
    } else if (type === 'height') { // Stature for > 24m
      return interpolateLMS(month, sex === 'male' ? CDC_HEIGHT_BOYS : CDC_HEIGHT_GIRLS);
    } else if (type === 'bmi') {
      return interpolateLMS(month, sex === 'male' ? CDC_BMI_BOYS : CDC_BMI_GIRLS);
    }

    // Fallback (should not be reached due to bounds checks in interpolateLMS)
    return { month, L: 0, M: 0, S: 0 };
};
